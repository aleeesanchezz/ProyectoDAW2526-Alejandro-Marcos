version: '3.9'

services:
  # ============================================
  # MYSQL DATABASE SERVICE
  # ============================================
  mysql:
    build:
      context: ..
      dockerfile: despliegue/docker/Dockerfile.mysql
    container_name: ecotrack-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_ecotrack_2024}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ecotrack}
      MYSQL_USER: ${MYSQL_USER:-ecotrack_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-ecotrack_pass_secure_2024}
      MYSQL_ROOT_HOST: '%'
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/initial.sql:/docker-entrypoint-initdb.d/01-initial.sql
      - ./database/data.sql:/docker-entrypoint-initdb.d/02-data.sql
    networks:
      - ecotrack-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SPRING BOOT BACKEND SERVICE
  # ============================================
  backend:
    build:
      context: ..
      dockerfile: despliegue/docker/Dockerfile.backend
    container_name: ecotrack-backend
    restart: unless-stopped
    environment:
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-ecotrack}?serverTimezone=UTC&allowPublicKeyRetrieval=true&useSSL=false
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-ecotrack_user}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-ecotrack_pass_secure_2024}
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      
      # Hibernate/JPA Configuration
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQL8Dialect
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.MySQL8Dialect
      
      # Server Configuration
      SERVER_PORT: 8080
      # REMOVED: SERVER_SERVLET_CONTEXT_PATH (routes already have /api prefix via @RequestMapping)
      
      # Logging
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_PROYECTO: DEBUG
      
      # Mail Configuration
      SPRING_MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      SPRING_MAIL_PORT: ${MAIL_PORT:-587}
      SPRING_MAIL_USERNAME: ${MAIL_USERNAME:-ecotrackiescastelar@gmail.com}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD:-app_password}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED: "true"
      SPRING_MAIL_DEFAULT_ENCODING: UTF-8
      
      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-https://ecotrack-pi.duckdns.org}
      
      # Frontend URL for email links (converted to app.frontend-url by Spring)
      APP_FRONTEND_URL: ${APP_FRONTEND_URL:-https://ecotrack-pi.duckdns.org}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ecotrack-network
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # ANGULAR FRONTEND SERVICE
  # ============================================
  frontend:
    build:
      context: ..
      dockerfile: despliegue/docker/Dockerfile.frontend
    container_name: ecotrack-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - ecotrack-network
    expose:
      - "80"
    environment:
      NGINX_HOST: ecotrack-frontend
      NGINX_PORT: 80
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 20
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # CADDY REVERSE PROXY
  # ============================================
  caddy:
    image: caddy:latest
    container_name: ecotrack-caddy
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    environment:
      DOMAIN: ${DOMAIN:-ecotrack-pi.duckdns.org}
      EMAIL: ${EMAIL:-admin@ecotrack.com}
    networks:
      - ecotrack-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# VOLUMES
# ============================================
volumes:
  mysql_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

# ============================================
# NETWORKS
# ============================================
networks:
  ecotrack-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
